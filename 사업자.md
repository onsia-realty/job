# 온시아 Job - 사업자 인증 시스템 개발 문서

> **작성일**: 2026-02-12
> **프로젝트**: 온시아 Job Matching Platform
> **대상**: 개발자 참고용 기술 문서

---

## 목차

1. [시스템 개요](#1-시스템-개요)
2. [인증 방법 3가지](#2-인증-방법-3가지)
3. [중개사무소 인증 (Broker Verification)](#3-중개사무소-인증)
4. [사업자등록번호 인증 (Business Number Verification)](#4-사업자등록번호-인증)
5. [명함 인증 (Card Verification)](#5-명함-인증)
6. [데이터 저장 구조](#6-데이터-저장-구조)
7. [데이터베이스 스키마](#7-데이터베이스-스키마)
8. [환경 변수](#8-환경-변수)
9. [파일 구조](#9-파일-구조)
10. [보안 및 주의사항](#10-보안-및-주의사항)
11. [알려진 한계 및 개선사항](#11-알려진-한계-및-개선사항)

---

## 1. 시스템 개요

사용자가 **공인중개사** 또는 **사업자**임을 인증하는 시스템입니다.
3가지 인증 방법을 제공하며, 인증 데이터는 **Supabase Auth의 user_metadata**에 저장됩니다.

### 전체 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                    클라이언트 (브라우저)                    │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │ 중개사무소    │  │ 사업자번호   │  │ 명함 인증       │  │
│  │ 인증 탭      │  │ 인증 탭     │  │ 탭              │  │
│  └──────┬──────┘  └──────┬──────┘  └───────┬─────────┘  │
└─────────┼────────────────┼─────────────────┼────────────┘
          │                │                 │
          ▼                ▼                 ▼
┌─────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ GET              │ │ POST             │ │ Supabase Storage │
│ /api/broker      │ │ /api/business-   │ │ (이미지 업로드)   │
│ ?regNo=XXXXX     │ │ verify           │ │                  │
└────────┬────────┘ └────────┬─────────┘ └────────┬─────────┘
         │                   │                     │
         ▼                   ▼                     ▼
┌──────────────────────────────────────────────────────────┐
│                   외부 API / Supabase                     │
│                                                          │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐ │
│  │ 공공데이터   │  │ 서울 열린   │  │ Supabase Auth       │ │
│  │ 포털 API    │  │ 데이터 API  │  │ user_metadata 저장  │ │
│  └────────────┘  └────────────┘  └─────────────────────┘ │
│                                                          │
│  ┌────────────┐  ┌─────────────────────────────────────┐ │
│  │ 국세청 NTS  │  │ Supabase DB (broker_offices 캐시)   │ │
│  │ (예정)      │  │                                     │ │
│  └────────────┘  └─────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

---

## 2. 인증 방법 3가지

| 방법 | 대상 | 외부 API | 인증 강도 |
|------|------|----------|-----------|
| **중개사무소 인증** | 공인중개사 | 공공데이터포털 + 서울 열린데이터 | 높음 (실시간 조회) |
| **사업자등록번호 인증** | 모든 사업자 | 국세청 NTS API (+ 체크섬) | 중간 |
| **명함 인증** | 분양상담사 등 | 없음 (이미지 업로드) | 낮음 (수동 확인) |

### UI 진입 경로

```
마이페이지 → 인증하기 버튼
→ /agent/mypage/verification

URL 해시로 탭 이동:
  /agent/mypage/verification#broker    → 중개사무소 탭
  /agent/mypage/verification#business  → 사업자번호 탭
  /agent/mypage/verification#card      → 명함 인증 탭
```

---

## 3. 중개사무소 인증

### 3.1 API 엔드포인트

```
GET /api/broker?regNo={개설등록번호}
GET /api/broker?test=true              ← API 상태 확인용
```

**파일 위치**: `src/app/api/broker/route.ts`

### 3.2 개설등록번호 형식

```
XXXXX - YYYY - NNNNN
  │       │      │
  │       │      └─ 일련번호 (5자리)
  │       └──────── 등록연도 (4자리)
  └──────────────── 지역코드/법정동코드 (5자리)
```

**예시**: `11710-2022-00250`

| 지역코드 | 지역 |
|----------|------|
| 11xxx | 서울특별시 |
| 26xxx | 부산광역시 |
| 27xxx | 대구광역시 |
| 28xxx | 인천광역시 |
| 41xxx | 경기도 |
| 47xxx | 경상북도 |
| 50xxx | 제주도 |

### 3.3 4단계 폴백(Fallback) 조회 아키텍처

조회 성공률을 최대화하기 위해 **4단계 폴백 전략**을 사용합니다.

```
┌──────────────────────────────────────────────────────────┐
│ STAGE 1: DB 캐시 (Supabase broker_offices 테이블)         │
│ 속도: 즉시 (~5-50ms)                                     │
│ 이전에 조회된 데이터가 있으면 바로 반환                      │
└──────────────────┬───────────────────────────────────────┘
                   │ 캐시 미스 (MISS)
                   ▼
┌──────────────────────────────────────────────────────────┐
│ STAGE 2: 공공데이터포털 API (전국)                         │
│ URL: http://api.data.go.kr/openapi/tn_pubr_public_med_  │
│      office_api                                          │
│ 방식: 개설등록번호로 직접 검색                               │
│ 속도: 1-3초 | 타임아웃: 15초                               │
│ 커버리지: 전국 (서울 일부 누락)                              │
└──────────────────┬───────────────────────────────────────┘
                   │ 결과 없음
                   ▼
┌──────────────────────────────────────────────────────────┐
│ STAGE 3: 서울 열린데이터광장 API                           │
│ URL: http://openapi.seoul.go.kr:8088/{KEY}/json/         │
│      landBizInfo/{start}/{end}/                           │
│ 조건: 지역코드가 11xxx (서울)인 경우만 실행                  │
│ 방식: 25,000건+ 페이지네이션 (1,000건씩, 3개 병렬 요청)     │
│ 속도: 3-10초 | 타임아웃: 각 요청 10초                       │
└──────────────────┬───────────────────────────────────────┘
                   │ 결과 없음
                   ▼
┌──────────────────────────────────────────────────────────┐
│ STAGE 4: 공공데이터포털 지역코드 검색 (폴백)                │
│ 방식: 등록번호 앞 5자리(지역코드)로 1,000건 광역 검색        │
│ 속도: 2-5초                                               │
└──────────────────┬───────────────────────────────────────┘
                   │ 결과 없음
                   ▼
┌──────────────────────────────────────────────────────────┐
│ 404 Not Found: "해당 등록번호로 등록된 중개사무소를           │
│ 찾을 수 없습니다"                                         │
└──────────────────────────────────────────────────────────┘
```

### 3.4 외부 API 상세

#### 공공데이터포털 API (전국)

```
URL: http://api.data.go.kr/openapi/tn_pubr_public_med_office_api
메서드: GET

파라미터:
  serviceKey   = {DATA_GO_KR_API_KEY}   ← 환경변수
  pageNo       = 1
  numOfRows    = 100
  type         = json
  ESTBL_REG_NO = {등록번호}              ← 반드시 대문자!
```

> **주의**: `ESTBL_REG_NO` 파라미터는 **반드시 대문자**여야 합니다.
> **주의**: URL은 반드시 **HTTP** (HTTPS 아님)를 사용해야 합니다.

**응답 필드 매핑**:

| API 응답 필드 | 시스템 필드 | 설명 |
|--------------|-----------|------|
| `medOfficeNm` | `medOfficeNm` | 중개사무소명 |
| `estblRegNo` | `estblRegNo` | 개설등록번호 |
| `opbizLreaClscSe` | `opbizLreaClscSe` | 종별구분 |
| `rprsvNm` | `rprsvNm` | 대표자명 |
| `lctnRoadNmAddr` | `lctnRoadNmAddr` | 도로명주소 |
| `lctnLotnoAddr` | `lctnLotnoAddr` | 지번주소 |
| `telno` (**소문자**) | `telNo` | 전화번호 |
| `estblRegYmd` (**다른 이름**) | `estblRegDe` | 개설등록일자 |
| `sttusSeNm` | `sttusSeNm` | 상태 (영업중/휴업/폐업) |
| `ddcJoinYn` (**다른 이름**) | `mdatJoinYn` | 공제가입유무 |
| `latitude` | `latitude` | 위도 |
| `longitude` | `longitude` | 경도 |

#### 서울 열린데이터광장 API

```
URL: http://openapi.seoul.go.kr:8088/{SEOUL_OPEN_API_KEY}/json/landBizInfo/{start}/{end}/
메서드: GET

파라미터는 URL 경로에 포함:
  {start} = 시작 인덱스 (1부터)
  {end}   = 끝 인덱스
```

> **특이사항**: 직접 검색 파라미터가 **없음** → 전체 데이터를 페이지네이션하며 매칭

**서울 API 필드 매핑**:

| 서울 API 필드 | 시스템 필드 | 설명 |
|-------------|-----------|------|
| `BZMN_CONM` | `medOfficeNm` | 사업자상호 |
| `REST_BRKR_INFO` | `estblRegNo` | 개설등록번호 |
| `BRKR_TP` | `opbizLreaClscSe` | 중개사유형 |
| `MDT_BSNS_NM` | `rprsvNm` | 중개사명 |
| `ADDR` | `lctnRoadNmAddr` | 주소 |
| `LOT_ADDR` | `lctnLotnoAddr` | 지번주소 |
| `TELNO` | `telNo` | 전화번호 |
| `RGST_DE` | `estblRegDe` | 등록일 |
| `STTS_SE` | `sttusSeNm` | 상태 |
| `GRTNT_YN` | `mdatJoinYn` | 공제가입 |

### 3.5 응답 형식

**성공 (200)**:
```json
{
  "data": {
    "medOfficeNm": "온시아공인중개사사무소",
    "estblRegNo": "11710-2022-00250",
    "opbizLreaClscSe": "공인중개사",
    "rprsvNm": "홍길동",
    "lctnRoadNmAddr": "서울특별시 송파구 중대로 197 3층",
    "lctnLotnoAddr": "서울특별시 송파구 가락동 123-4",
    "telNo": "02-1234-5678",
    "estblRegDe": "2022-08-03",
    "sttusSeNm": "영업중",
    "mdatJoinYn": "Y",
    "latitude": "37.4967",
    "longitude": "127.1182"
  },
  "source": "cache"
}
```

`source` 값: `"cache"` | `"national"` | `"seoul"`

**에러 응답**:

| 코드 | 메시지 |
|------|--------|
| 400 | 개설등록번호를 입력해주세요 |
| 400 | 개설등록번호 형식이 올바르지 않습니다 (예: 11710-2022-00250) |
| 404 | 해당 등록번호로 등록된 중개사무소를 찾을 수 없습니다 |
| 500 | 중개사무소 정보 조회 중 오류가 발생했습니다 |

### 3.6 캐시 저장 (DB Upsert)

조회 성공 시 `broker_offices` 테이블에 자동 캐싱:

```typescript
await supabase.from('broker_offices').upsert({
  estbl_reg_no: info.estblRegNo,       // PK (UNIQUE)
  med_office_nm: info.medOfficeNm,
  rprsv_nm: info.rprsvNm,
  lctn_road_nm_addr: info.lctnRoadNmAddr,
  // ... 나머지 필드
  data_source: source,                  // 'national' | 'seoul'
  last_synced_at: new Date().toISOString()
}, { onConflict: 'estbl_reg_no' });     // 중복 시 업데이트
```

---

## 4. 사업자등록번호 인증

### 4.1 API 엔드포인트

```
POST /api/business-verify
Content-Type: application/json

{
  "businessNumber": "1234567890"
}
```

**파일 위치**: `src/app/api/business-verify/route.ts`

### 4.2 검증 프로세스

```
사용자 입력 (XXX-XX-XXXXX)
       │
       ▼
┌──────────────────────┐
│ 1. 하이픈 제거        │  "123-45-67890" → "1234567890"
│    숫자만 추출        │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ 2. 길이 검증          │  10자리가 아니면 → 400 에러
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 3. 체크섬 검증 (가중치 알고리즘)           │
│                                          │
│  자릿수:    1  2  3  4  5  6  7  8  9  10│
│  가중치:    1  3  7  1  3  7  1  3  5    │
│                                          │
│  sum = Σ(digit[i] * weight[i]) for i=0~8 │
│  sum += floor(digit[8] * 5 / 10)         │
│  checkDigit = (10 - (sum % 10)) % 10     │
│  검증: checkDigit === digit[9]            │
│                                          │
│  실패 시 → 400 "유효하지 않은 사업자등록번호"│
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 4. 사업자 유형 판별                        │
│                                          │
│  4~5번째 자리 (typeCode):                 │
│  81~89 → 법인사업자                       │
│  그 외  → 개인사업자                       │
└──────────┬───────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────┐
│ 5. 국세청 API 조회 (선택적)               │
│                                          │
│  API 키가 있으면 → 국세청에서 실제 상태 조회 │
│  API 키가 없으면 → 체크섬 검증 결과만 반환   │
└──────────────────────────────────────────┘
```

### 4.3 체크섬 검증 코드

```typescript
function validateBusinessNumberChecksum(bNo: string): boolean {
  if (bNo.length !== 10) return false;

  const digits = bNo.split('').map(Number);
  const weights = [1, 3, 7, 1, 3, 7, 1, 3, 5];

  let sum = 0;
  for (let i = 0; i < 9; i++) {
    sum += digits[i] * weights[i];
  }
  sum += Math.floor((digits[8] * 5) / 10);

  const checkDigit = (10 - (sum % 10)) % 10;
  return checkDigit === digits[9];
}
```

### 4.4 사업자 유형 판별

```typescript
function detectBizType(bNo: string): {
  biz_type: 'individual' | 'corporate';
  biz_type_label: string;
} {
  const typeCode = parseInt(bNo.substring(3, 5), 10);

  // 4~5번째 자릿수가 81~89면 법인
  if (typeCode >= 81 && typeCode <= 89) {
    return { biz_type: 'corporate', biz_type_label: '법인사업자' };
  }
  return { biz_type: 'individual', biz_type_label: '개인사업자' };
}
```

### 4.5 응답 형식

**성공 (200)**:
```json
{
  "data": {
    "b_no": "1234567890",
    "b_stt": "계속사업자",
    "b_stt_cd": "01",
    "tax_type": "부가가치세 일반과세자",
    "tax_type_cd": "01",
    "end_dt": "",
    "checksum_valid": true,
    "verification_method": "nts_api",
    "biz_type": "individual",
    "biz_type_label": "개인사업자"
  }
}
```

| 필드 | 설명 | 값 |
|------|------|-----|
| `b_stt` | 사업 상태 | `계속사업자` / `휴업자` / `폐업자` |
| `b_stt_cd` | 상태 코드 | `01`(계속) / `02`(휴업) / `03`(폐업) |
| `verification_method` | 검증 방법 | `nts_api`(국세청) / `checksum_only`(체크섬만) |
| `biz_type` | 사업자 유형 | `individual` / `corporate` |

**에러 응답**:

| 코드 | 메시지 |
|------|--------|
| 400 | 사업자등록번호 10자리를 입력해주세요 |
| 400 | 유효하지 않은 사업자등록번호입니다. 번호를 다시 확인해주세요 |

---

## 5. 명함 인증

### 5.1 프로세스

외부 API 없이 **이미지 업로드 + 정보 입력** 방식입니다.

```
┌──────────────────────┐
│ 사용자가 명함 사진     │
│ 업로드 (또는 드래그)    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────┐
│ 클라이언트 처리:               │
│ 1. 파일 크기 검증 (최대 2MB)   │
│ 2. 이미지 리사이즈             │
│    → 800x600px, JPEG 80%     │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Supabase Storage 업로드:      │
│ 버킷: job-images              │
│ 경로: card-images/{ts}-{rnd}  │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 사용자 추가 정보 입력:         │
│ - 이름 (필수)                 │
│ - 소속회사 (필수)              │
│ - 분양현장명 (필수)            │
│ - 연락처 (선택)               │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Supabase Auth 메타데이터 저장  │
│ → cardVerified: true         │
│ → cardImageUrl: public URL   │
└──────────────────────────────┘
```

### 5.2 이미지 업로드 설정

**파일 위치**: `src/lib/upload.ts`

```typescript
// 설정값
const MAX_FILE_SIZE = 2 * 1024 * 1024;  // 2MB
const BUCKET = 'job-images';

const IMAGE_SIZE_LIMITS = {
  'card-images': {
    maxWidth: 800,
    maxHeight: 600,
    quality: 0.80
  }
};
```

---

## 6. 데이터 저장 구조

### 6.1 Supabase Auth user_metadata

모든 인증 데이터는 **Supabase Auth의 user_metadata**에 저장됩니다.

```typescript
// 저장 함수 (src/lib/auth.ts)
export async function updateUserMetadata(metadata: Record<string, any>) {
  const { data, error } = await supabase.auth.updateUser({
    data: metadata,
  });
  if (error) throw error;
  return data;
}
```

#### 중개사무소 인증 시 저장되는 메타데이터

```typescript
{
  brokerVerified: true,                    // 인증 여부
  brokerRegNo: "11710-2022-00250",         // 개설등록번호
  brokerOfficeName: "온시아공인중개사사무소", // 사무소명
  brokerAddress: "서울특별시 송파구...",      // 주소
  brokerRegDate: "2022-08-03",             // 개설등록일
  brokerTaxEmail: "tax@company.com"        // 세금계산서 이메일
}
```

#### 사업자등록번호 인증 시 저장되는 메타데이터

```typescript
{
  businessVerified: true,                  // 인증 여부
  businessNumber: "1234567890",            // 사업자등록번호
  businessStatus: "계속사업자",              // 사업 상태
  businessTaxType: "부가가치세 일반과세자",   // 과세 유형
  bizType: "individual",                   // 개인/법인
  bizTypeLabel: "개인사업자",               // 유형 레이블
  bizName: "온시아부동산",                  // 상호 (사용자 입력, 필수)
  bizSector: "부동산업",                   // 업태 (사용자 입력)
  bizItem: "중개",                         // 종목 (사용자 입력)
  bizEmail: "biz@company.com"             // 세금계산서 이메일
}
```

#### 명함 인증 시 저장되는 메타데이터

```typescript
{
  cardVerified: true,                      // 인증 여부
  cardName: "홍길동",                       // 이름
  cardCompany: "온시아분양",                 // 소속회사
  cardProject: "래미안원펜타스",              // 분양현장명
  cardPhone: "010-1234-5678",              // 연락처
  cardImageUrl: "https://...supabase.co/..." // 명함 이미지 URL
}
```

### 6.2 데이터 접근 방법

```typescript
import { useAuth } from '@/contexts/AuthContext';

function MyComponent() {
  const { user } = useAuth();
  const meta = user?.user_metadata;

  // 인증 상태 확인
  const isBrokerVerified = meta?.brokerVerified === true;
  const isBusinessVerified = meta?.businessVerified === true;
  const isCardVerified = meta?.cardVerified === true;

  // 인증 데이터 사용
  const officeName = meta?.brokerOfficeName;
  const businessNumber = meta?.businessNumber;
}
```

---

## 7. 데이터베이스 스키마

### broker_offices 테이블 (캐시용)

**마이그레이션 파일**: `supabase/migrations/004_broker_offices.sql`

```sql
CREATE TABLE IF NOT EXISTS broker_offices (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,

  -- 핵심 필드
  estbl_reg_no TEXT NOT NULL UNIQUE,          -- 개설등록번호 (유니크키)
  med_office_nm TEXT NOT NULL DEFAULT '',      -- 중개사무소명
  opbiz_lrea_clsc_se TEXT DEFAULT '',          -- 종별구분
  rprsv_nm TEXT DEFAULT '',                    -- 대표자명

  -- 주소
  lctn_road_nm_addr TEXT DEFAULT '',           -- 도로명주소
  lctn_lotno_addr TEXT DEFAULT '',             -- 지번주소

  -- 부가 정보
  tel_no TEXT DEFAULT '',                      -- 전화번호
  estbl_reg_de TEXT DEFAULT '',                -- 개설등록일자
  sttus_se_nm TEXT DEFAULT '영업중',            -- 상태 (영업중/휴업/폐업)
  mdat_join_yn TEXT DEFAULT '',                -- 공제가입유무

  -- 좌표
  latitude TEXT DEFAULT '',                    -- 위도
  longitude TEXT DEFAULT '',                   -- 경도

  -- 메타
  lawd_cd TEXT DEFAULT '',                     -- 법정동코드
  data_source TEXT DEFAULT 'api',              -- 데이터 출처
  last_synced_at TIMESTAMPTZ DEFAULT NOW(),    -- 마지막 동기화
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_broker_estbl_reg_no ON broker_offices(estbl_reg_no);
CREATE INDEX idx_broker_lawd_cd ON broker_offices(lawd_cd);
CREATE INDEX idx_broker_med_office_nm ON broker_offices(med_office_nm);
CREATE INDEX idx_broker_sttus ON broker_offices(sttus_se_nm);

-- RLS 정책
ALTER TABLE broker_offices ENABLE ROW LEVEL SECURITY;
CREATE POLICY "broker_offices_select" ON broker_offices FOR SELECT USING (true);
CREATE POLICY "broker_offices_insert" ON broker_offices FOR INSERT WITH CHECK (true);
CREATE POLICY "broker_offices_update" ON broker_offices FOR UPDATE USING (true);
```

---

## 8. 환경 변수

### 필수 환경 변수 (`.env.local`)

```env
# Supabase (필수)
NEXT_PUBLIC_SUPABASE_URL=https://[project-id].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon-key]
SUPABASE_SERVICE_ROLE_KEY=[service-role-key]    # 서버 전용

# 중개사무소 조회 API (필수)
DATA_GO_KR_API_KEY=[공공데이터포털-서비스키]
SEOUL_OPEN_API_KEY=[서울-열린데이터광장-인증키]

# Google OAuth (로그인용)
NEXT_PUBLIC_GOOGLE_CLIENT_ID=[google-client-id]
```

### API 키 발급처

| API | 발급 URL | 신청 방법 |
|-----|---------|-----------|
| 공공데이터포털 | https://www.data.go.kr | "전국 공인중개사사무소 표준데이터" 검색 → 활용신청 |
| 서울 열린데이터광장 | https://data.seoul.go.kr | 회원가입 → 인증키 신청/관리 |
| Supabase | https://supabase.com | 프로젝트 Settings → API |

---

## 9. 파일 구조

```
src/
├── app/
│   ├── api/
│   │   ├── broker/
│   │   │   └── route.ts              ← 중개사무소 조회 API
│   │   └── business-verify/
│   │       └── route.ts              ← 사업자등록번호 검증 API
│   └── agent/
│       └── mypage/
│           └── verification/
│               └── page.tsx          ← 인증 UI (3개 탭)
├── lib/
│   ├── auth.ts                       ← updateUserMetadata() 등
│   ├── supabase.ts                   ← 클라이언트 Supabase
│   ├── supabase-server.ts            ← 서버 Supabase (service role)
│   └── upload.ts                     ← 이미지 업로드/리사이즈
├── contexts/
│   └── AuthContext.tsx               ← useAuth() 훅
├── types/
│   └── index.ts                      ← VerificationStatus 등 타입
└── components/
    └── providers/
        └── Providers.tsx             ← AuthProvider 래퍼

supabase/
└── migrations/
    └── 004_broker_offices.sql        ← DB 스키마
```

---

## 10. 보안 및 주의사항

### API 키 보안
- `DATA_GO_KR_API_KEY`, `SEOUL_OPEN_API_KEY`는 **서버 사이드에서만** 사용
- `NEXT_PUBLIC_` 접두사가 **없으므로** 클라이언트에 노출되지 않음
- `.env.local`은 절대 git에 커밋하지 않을 것 (`.gitignore`에 포함)

### 데이터 보안
- 인증 데이터는 Supabase Auth `user_metadata`에 저장 (암호화)
- `broker_offices` 테이블은 RLS 적용 (SELECT: 공개, INSERT/UPDATE: 서버 전용)
- 명함 이미지는 Supabase Storage에 저장 (공개 URL)

### 입력 검증 레이어

```
클라이언트 검증 (UI)
  → 형식 검증 (정규식, 길이)
  → 파일 크기 검증 (2MB)

서버 검증 (API)
  → 입력 살균 (특수문자 제거)
  → 체크섬 검증 (사업자번호)
  → 형식 검증 (XXXXX-YYYY-NNNNN)
  → 외부 API 호출 (에러 핸들링)
```

---

## 11. 알려진 한계 및 개선사항

### 현재 한계

| 항목 | 설명 |
|------|------|
| 공공데이터 불완전 | 일부 지자체 데이터 누락 |
| 서울 API 속도 | 25,000건+ 페이지네이션으로 첫 조회 시 3-10초 |
| 좌표 데이터 | 서울 API는 위도/경도 미제공 |
| 국세청 API | 현재 API 키 미설정 시 체크섬만으로 검증 |
| 명함 인증 | 자동 검증 없음 (수동 확인 필요) |

### 향후 개선 방향

1. **LOCALDATA 연동** (`localdata.go.kr`)
   - 전국 중개사무소 데이터 100% 커버리지
   - 대량 CSV 임포트 → DB 캐시 → 즉시 조회

2. **국세청 API 정식 연동**
   - 사업자 상태 실시간 확인
   - 휴/폐업 여부 정확한 판별

3. **지오코딩 연동**
   - Vworld API로 주소 → 좌표 변환
   - 지도 기반 사무소 위치 표시

4. **명함 OCR**
   - AI 기반 명함 텍스트 자동 인식
   - 입력 자동 완성

---

## 테스트 검증된 등록번호

| 지역 | 등록번호 | 사무소명 | 데이터 출처 |
|------|---------|---------|------------|
| 서울 | 11710-2022-00250 | 온시아공인중개사사무소 | 서울 API |
| 인천 | 28177-2022-00104 | 당근공인중개사사무소 | 전국 API |
| 제주 | 50130-2022-00006 | 제주대지공인중개사사무소 | 전국 API |
| 경기 | 41500-2020-00013 | 한양수자인공인중개사사무소 | 전국 API |
| 경북 | 47290-2022-00001 | 뉴황금공인중개사사무소 | 전국 API |

### API 상태 확인

```
GET /api/broker?test=true
```

이 엔드포인트로 DB 연결, API 키 설정, 캐시된 데이터 수를 확인할 수 있습니다.

---

*Last Updated: 2026-02-12*
